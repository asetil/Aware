<!DOCTYPE html>
<html>

<head>
    <title>Secure SignalR Example</title>
    <script src="node_modules/@microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="secure-api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }

        .login-panel {
            grid-column: span 2;
            background: #e8f4fd;
        }

        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .hidden {
            display: none;
        }

        #rooms {
            list-style: none;
            padding: 0;
            max-width: 200px;
        }

        #rooms li {
            background: #dc143c;
            color: #fff;
            font-weight: 600;
            padding: 7px 14px;
            border-radius: 5px;
            margin-bottom: 7px;
        }
    </style>
</head>

<body>
    <h1>Secure SignalR Example with Advanced API Protection</h1>
    
    <div class="login-panel panel">
        <h3>Authentication</h3>
        <div id="loginForm">
            <input type="text" id="username" placeholder="Username (demo)" value="demo">
            <input type="password" id="password" placeholder="Password (password)" value="password">
            <button onclick="login()">Login</button>
        </div>
        <div id="loggedInInfo" class="hidden">
            <span id="userInfo"></span>
            <button onclick="logout()">Logout</button>
        </div>
        <div id="authStatus"></div>
    </div>

    <div class="container">
        <div class="panel">
            <h3>API Testing</h3>
            <button onclick="testPublicAPI()" id="testPublicBtn">Test Public API</button>
            <button onclick="testProtectedAPI()" id="testProtectedBtn" disabled>Test Protected API</button>
            <button onclick="testSensitiveAPI()" id="testSensitiveBtn" disabled>Test Sensitive API (Signed)</button>
            <button onclick="testRateLimiting()" id="testRateLimitBtn" disabled>Test Rate Limiting</button>
            
            <h4>API Response</h4>
            <div id="apiResponse" class="log"></div>
        </div>

        <div class="panel">
            <h3>SignalR Chat</h3>
            <div>
                <input type="text" id="roomName" placeholder="Room name">
                <button onclick="joinRoom()" id="joinRoomBtn" disabled>Join Room</button>
            </div>
            <div>
                <input type="text" id="txtMessage" placeholder="Message">
                <button onclick="sendMessage()" id="sendMessageBtn" disabled>Send Message</button>
            </div>
            
            <h4>Rooms</h4>
            <ul id="rooms"></ul>
            
            <h4>Messages</h4>
            <div id="messages" class="log"></div>
        </div>
    </div>

    <div class="panel">
        <h3>Security Logs</h3>
        <div id="securityLog" class="log"></div>
    </div>

    <script>
        let apiClient;
        let signalRConnection;
        let currentRoom = 'lobby';

        $(document).ready(() => {
            apiClient = new SecureApiClient('https://localhost:5001');
            
            // Set up authentication error handler
            apiClient.onAuthError = () => {
                showStatus('Authentication failed - please log in again', 'error');
                logout();
            };

            logSecurity('Application initialized');
        });

        async function login() {
            const username = $('#username').val();
            const password = $('#password').val();

            try {
                showStatus('Logging in...', 'info');
                const result = await apiClient.login(username, password);
                
                showStatus('Login successful!', 'success');
                logSecurity(`Login successful for user: ${username}`);
                logSecurity(`Browser fingerprint: ${result.browserFingerprint}`);
                
                $('#loginForm').addClass('hidden');
                $('#loggedInInfo').removeClass('hidden');
                $('#userInfo').text(`Logged in as: ${username}`);
                
                // Enable protected features
                enableProtectedFeatures();
                
                // Initialize SignalR with authentication
                await initializeSignalR();
                
            } catch (error) {
                showStatus(`Login failed: ${error.message}`, 'error');
                logSecurity(`Login failed for user: ${username} - ${error.message}`);
            }
        }

        async function logout() {
            try {
                if (apiClient) {
                    await apiClient.logout();
                }
                
                if (signalRConnection) {
                    await signalRConnection.stop();
                }
                
                showStatus('Logged out successfully', 'success');
                logSecurity('User logged out');
                
                $('#loginForm').removeClass('hidden');
                $('#loggedInInfo').addClass('hidden');
                
                // Disable protected features
                disableProtectedFeatures();
                
            } catch (error) {
                showStatus(`Logout error: ${error.message}`, 'error');
            }
        }

        async function initializeSignalR() {
            try {
                signalRConnection = new signalR.HubConnectionBuilder()
                    .withUrl("https://localhost:5001/myhub", {
                        accessTokenFactory: () => apiClient.accessToken
                    })
                    .build();

                signalRConnection.start()
                    .then(() => {
                        logSecurity('SignalR connection established');
                        $('#joinRoomBtn, #sendMessageBtn').prop('disabled', false);
                        
                        // Auto-join lobby
                        signalRConnection.invoke("JoinRoom", currentRoom);
                        $('#rooms').append(`<li>lobby (auto-joined)</li>`);
                    })
                    .catch(error => {
                        logSecurity(`SignalR connection failed: ${error}`);
                    });

                signalRConnection.on("receiveMessage", message => {
                    $("#messages").append(`${new Date().toLocaleTimeString()}: ${message}<br>`);
                    $("#messages").scrollTop($("#messages")[0].scrollHeight);
                });

            } catch (error) {
                logSecurity(`SignalR initialization failed: ${error}`);
            }
        }

        async function joinRoom() {
            const roomName = $('#roomName').val();
            if (!roomName || !signalRConnection) return;

            try {
                await signalRConnection.invoke("JoinRoom", roomName);
                $('#rooms').append(`<li>${roomName}</li>`);
                currentRoom = roomName;
                logSecurity(`Joined room: ${roomName}`);
            } catch (error) {
                logSecurity(`Failed to join room: ${error}`);
            }
        }

        async function sendMessage() {
            const message = $('#txtMessage').val();
            if (!message || !signalRConnection) return;

            try {
                await signalRConnection.invoke("SendMessageToGroup", currentRoom, message);
                $('#txtMessage').val('');
            } catch (error) {
                logSecurity(`Failed to send message: ${error}`);
            }
        }

        async function testPublicAPI() {
            try {
                updateApiResponse('Testing public endpoint...');
                
                // This would be a public endpoint that doesn't require authentication
                const response = await fetch('https://localhost:5001/api/health', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    updateApiResponse('Public API: ✅ Accessible (as expected)');
                } else {
                    updateApiResponse(`Public API: ❌ Error ${response.status}`);
                }
            } catch (error) {
                updateApiResponse(`Public API: ❌ ${error.message}`);
            }
        }

        async function testProtectedAPI() {
            try {
                updateApiResponse('Testing protected endpoint...');
                const data = await apiClient.get('/api/user/profile');
                updateApiResponse(`Protected API: ✅ Success\n${JSON.stringify(data, null, 2)}`);
                logSecurity('Protected API access successful');
            } catch (error) {
                updateApiResponse(`Protected API: ❌ ${error.message}`);
                logSecurity(`Protected API access failed: ${error.message}`);
            }
        }

        async function testSensitiveAPI() {
            try {
                updateApiResponse('Testing sensitive endpoint with request signing...');
                const data = await apiClient.getSecure('/api/user/sensitive');
                updateApiResponse(`Sensitive API: ✅ Success\n${JSON.stringify(data, null, 2)}`);
                logSecurity('Sensitive API access successful (request signed)');
            } catch (error) {
                updateApiResponse(`Sensitive API: ❌ ${error.message}`);
                logSecurity(`Sensitive API access failed: ${error.message}`);
            }
        }

        async function testRateLimiting() {
            updateApiResponse('Testing rate limiting (sending multiple requests)...');
            
            for (let i = 1; i <= 15; i++) {
                try {
                    const data = await apiClient.get('/api/user/profile');
                    updateApiResponse(`Request ${i}: ✅ Success`);
                } catch (error) {
                    updateApiResponse(`Request ${i}: ❌ Rate limited - ${error.message}`);
                    logSecurity(`Rate limiting triggered on request ${i}`);
                    break;
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        function enableProtectedFeatures() {
            $('#testProtectedBtn, #testSensitiveBtn, #testRateLimitBtn').prop('disabled', false);
        }

        function disableProtectedFeatures() {
            $('#testProtectedBtn, #testSensitiveBtn, #testRateLimitBtn, #joinRoomBtn, #sendMessageBtn').prop('disabled', true);
            $('#rooms, #messages, #apiResponse').empty();
        }

        function showStatus(message, type) {
            $('#authStatus').html(`<div class="status ${type}">${message}</div>`);
        }

        function updateApiResponse(message) {
            $('#apiResponse').append(`${new Date().toLocaleTimeString()}: ${message}\n`);
            $('#apiResponse').scrollTop($('#apiResponse')[0].scrollHeight);
        }

        function logSecurity(message) {
            $('#securityLog').append(`${new Date().toLocaleTimeString()}: ${message}\n`);
            $('#securityLog').scrollTop($('#securityLog')[0].scrollHeight);
        }

        // Simulate suspicious client behavior for testing
        async function simulateSuspiciousRequest() {
            try {
                const response = await fetch('https://localhost:5001/api/user/profile', {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'curl/7.68.0',  // This will be blocked
                        'Authorization': `Bearer ${apiClient.accessToken}`
                    }
                });
                
                updateApiResponse('Suspicious request: This should have been blocked!');
            } catch (error) {
                updateApiResponse(`Suspicious request correctly blocked: ${error.message}`);
            }
        }
    </script>
</body>

</html>